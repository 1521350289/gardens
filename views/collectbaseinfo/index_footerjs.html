<!-- 表格插件 -->
<script src="/static/plugins/bootstrap-table/bootstrap-table.js" type="text/javascript"></script>
<script src="/static/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js" type="text/javascript"></script>
<script src="/static/plugins/bootstrap-table/extensions/cookie/bootstrap-table-cookie.js"></script>
<script src="/static/plugins/bootstrap-table/extensions/export/bootstrap-table-export.min.js"></script>
<script src="/static/plugins/bootstrap-table/extensions/sticky-header/bootstrap-table-sticky-header.min.js"></script>
<script src="/static/plugins/echarts/echarts.min.js"></script>

<script>
    var $dataGrid = $('#dataGrid');
    var $searchForm = $("#searchForm");

    // $('#electricityChart').css('width', $('#electricityChart').width());
    var electricityChart = echarts.init(document.getElementById('electricityChart'));
    var voltageChart = echarts.init(document.getElementById('voltageChart'));
    var powerfactorChart = echarts.init(document.getElementById('powerfactorChart'));
    var totalPateeChart = echarts.init(document.getElementById('totalPateeChart'));

    //初始化加载
    $(function () {
        pageInit();
    });

    //初始化页面
    function pageInit() {
        //初始化查询条件
        queryParamsInit();

        //初始化表格
        dataGridInit();

        //搜索
        $("#btnSearch").on("click", function (e) {
            refreshToFirstPage();
            collectRowsToday();
        });

        //清除搜索
        $("#btnClearSearch").on("click", function (e) {
            $('select', $searchForm).selectpicker('val', '');
            $('input', $searchForm).val('');

            refreshToFirstPage();
        });

        //保持搜索条件面板状态
        sdtheme.searchPanelStatusInit('searchpanelbtn');

        $(window).resize(function () {
            electricityChart.resize();
            voltageChart.resize();
            powerfactorChart.resize();
            totalPateeChart.resize();
        });
    }

    //刷新并跳转至第一页
    function refreshToFirstPage() {
        //表格刷新时，保存查询条件到cookie
        sdtheme.saveSearchText('searchForm');

        //刷新并跳转至第1页
        $dataGrid.bootstrapTable('refresh', {pageNumber: 1});

        //同时要更新cookie里保存当前页码
        $.cookie('dataGrid.bs.table.pageNumber', 1, {expires: 1});
    }

    //查询条件初始化
    function queryParamsInit() {
        //从cookie加载查询条件，传入参数为form id
        sdtheme.loadSearchText('searchForm');

        if($("#DTU_no").val().length == 0){
            $('.searchForm input[name="DTU_no"]').val('900000000001');
        }

        layui.use('laydate', function () {
            var laydate = layui.laydate;
            laydate.render({
                elem: '#CollectTime',
                value: new Date().format("yyyy-MM-dd"),
                max: 0
            });
        });
    }

    //bootstrap table data init
    function dataGridInit() {
        $dataGrid.bootstrapTable({
            method: 'post',
            url: '{{ urlfor "CollectBaseInfoController.DataGrid"}}',
            sidePagination: 'server',   //服务器端用 server
            idField: 'CollectTime',     //标识哪个字段为id主键
            queryParamsType: 'limit',   //参数格式,发送标准的RESTFul类型的参数请求
            queryParams: function (params) {
                params.CollectTime  = $('.searchForm input[name="CollectTime"]').val();
                params.DTU_no       = $('.searchForm input[name="DTU_no"]').val();
                params.MeterAddress = $('.searchForm input[name="MeterAddress"]').val();
                return params;
            },
            striped: true,         //使表格带有条纹
            pagination: true,      //在表格底部显示分页工具栏
            showRefresh: true,     //显示刷新按钮
            showColumns: false,    //显示隐藏列
            toolbar: '#toolbar',    //设置工具栏的Id或者class
            pageSize: 10,
            pageList: [5, 10, 20, 100, 200],
            paginationShowPageGo: false,    //20170812 lht 扩展select跳转
            paginationUseBSSelect: false,   //20170812 lht 扩展select跳转 启用BoostrapSelect(页面须引用botstrap-select.min.js)
            cookie: true,
            classes: 'table table-bordered table-hover',
            undefinedText: '',
            sortName: 'CollectTime',
            showToggle: true,
            sortOrder: 'asc',
            showExport: true,
            exportDataType: 'all',
            stickyHeader: true,

            columns: [
                [
                    {
                        field: 'CollectTime',
                        title: '采集时间',
                        valign: 'middle',
                        align: 'center',
                        class: 'W160',
                        formatter: sdtheme.formatterDateBySpan,
                        colspan: 1,        //规定表头单元格可横跨的列数
                        rowspan: 2         //规定表头单元格可横跨的行数
                    }, {
                        field: 'DTU_no',
                        title: 'DTU编号',
                        valign:"middle",
                        align: 'center',
                        width: '120px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'MeterAddress',
                        title: '电表地址',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        title: "电流 (I)",
                        valign:"middle",
                        align:"center",
                        colspan: 3,
                        rowspan: 1
                    }, {
                        title: "电压 (U)",
                        valign:"middle",
                        align:"center",
                        colspan: 3,
                        rowspan: 1
                    }, {
                        title: "功率因数",
                        valign:"middle",
                        align:"center",
                        colspan: 4,
                        rowspan: 1
                    }, {
                        title: "视在功率",
                        valign:"middle",
                        align:"center",
                        colspan: 4,
                        rowspan: 1
                    }, {
                        title: "有功功率",
                        valign:"middle",
                        align:"center",
                        colspan: 4,
                        rowspan: 1
                    }, {
                        title: "线电压",
                        valign:"middle",
                        align:"center",
                        colspan: 3,
                        rowspan: 1
                    }, {
                        field: 'Total_p_at_ee',
                        title: '3相总正向有功电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_r_at_ee',
                        title: '3相总反向有功电能',
                        valign:"middle",
                        width: '110px',
                        align: 'center',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_p_reat_ee',
                        title: '3相总正向无功电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_r_reat_ee',
                        title: '3相总反向无功电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_at_ee',
                        title: '3相总有功电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_ap_reat_ee',
                        title: '3相总无功电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Total_ap_a_ee',
                        title: '3相总视在电能',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }, {
                        field: 'Frequency',
                        title: '频率',
                        valign:"middle",
                        align: 'center',
                        width: '110px',
                        colspan: 1,
                        rowspan: 2
                    }
                ],

                [
                    {
                        field: 'A_electricity',
                        title: 'A相电流',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'B_electricity',
                        title: 'B相电流',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'C_electricity',
                        title: 'C相电流',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'A_voltage',
                        title: 'A相电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'B_voltage',
                        title: 'B相电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'C_voltage',
                        title: 'C相电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'A_power_factor',
                        title: 'A相功率因数',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'B_power_factor',
                        title: 'B相功率因数',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'C_power_factor',
                        title: 'C相功率因数',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'Total_power_factor',
                        title: '3相总功率因数',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'A_reactive_power',
                        title: 'A相视在功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'B_reactive_power',
                        title: 'B相视在功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'C_reactive_power',
                        title: 'C相视在功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'Total_reactive_power',
                        title: '3相总视在功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'A_active_power',
                        title: 'A相有功功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'B_active_power',
                        title: 'B相有功功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'C_active_power',
                        title: 'C相有功功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    },  {
                        field: 'Total_active_power',
                        title: '3相总有功功率',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'Uab_line_voltage',
                        title: 'A,B线电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'Ubc_line_voltage',
                        title: 'B,C线电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }, {
                        field: 'Uac_line_voltage',
                        title: 'A,C线电压',
                        width: '110px',
                        valign:"middle",
                        align: 'center'
                    }
                ]
             ],
            onLoadSuccess: function (data) {
                layer.closeAll('loading');
            },
            onSort: function (name, order) {

            },
            onPageChange: function () {

            },
            onCheckAll: function (rows) {

            },
            onCheck: function (rows) {

            },
            onUncheck: function (rows) {

            },
            onUncheckAll: function () {

            },
            onLoadError: function (status) {
                layer.alert('获取数据失败,错误代码：' + status);
            }
        });
    }

    //echarts
    function collectRowsToday() {
        var url = '{{ urlfor "CollectBaseInfoController.DataList"}}';
        var param ={CollectTime: $('.searchForm input[name="CollectTime"]').val(),
                    DTU_no: $('.searchForm input[name="DTU_no"]').val(),
                    MeterAddress: $('.searchForm input[name="MeterAddress"]').val()
                };
        $.sdpost(url, param, function (re) {
            if (re.code === 0) {
                var dateList = re.obj.map(function (item) {
                    return new Date(item.CollectTime).format("hh:mm:ss");
                });

                var option = {
                    title: {
                        text: '24小时数据',
                        subtext: '5分钟一条'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data:['A相电流','B相电流','C相电流']
                    },
                    toolbox:{
                        show: true,
                        orient: 'vertical',
                        left: 'right',
                        top: 'center',
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,

                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dateList,

                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        axisLabel: {
                            formatter: function (val) {
                                return val;
                            }
                        },

                        splitLine: {
                            show: false
                        },
                        scale: true
                    },
                    series: [ {
                        name: 'A相电流',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.A_electricity;
                        }),
                        showSymbol: false
                    }, {
                        name: 'B相电流',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.B_electricity;
                        }),
                        showSymbol: false
                    }, {
                        name: 'C相电流',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.C_electricity;
                        }),
                        showSymbol: false
                    }]
                };
                electricityChart.setOption(option);

                var option2 = {
                    title: {
                        text: '24小时数据',
                        subtext: '5分钟一条'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data:['A相电压','B相电压','C相电压']
                    },
                    toolbox:{
                        show: true,
                        orient: 'vertical',
                        left: 'right',
                        top: 'center',
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dateList,
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        axisLabel: {
                            formatter: function (val) {
                                return val;
                            }
                        },
                        splitLine: {
                            show: false
                        },
                        scale: true
                    },
                    series: [ {
                        name: 'A相电压',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.A_voltage;
                        }),
                        showSymbol: false
                    }, {
                        name: 'B相电压',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.B_voltage;
                        }),
                        showSymbol: false
                    }, {
                        name: 'C相电压',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.C_voltage;
                        }),
                        showSymbol: false
                    }]
                };
                voltageChart.setOption(option2);

                var option3 = {
                    title: {
                        text: '24小时数据',
                        subtext: '5分钟一条'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data:['A相功率因数','B相功率因数','C相功率因数', '3相总功率因数']
                    },
                    toolbox:{
                        show: true,
                        orient: 'vertical',
                        left: 'right',
                        top: 'center',
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dateList,
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        axisLabel: {
                            formatter: function (val) {
                                return val;
                            }
                        },
                        splitLine: {
                            show: false
                        },
                        scale: true
                    },
                    series: [ {
                        name: 'A相功率因数',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.A_power_factor;
                        }),
                        markLine: {
                            data: [
                                {type: 'average', name: '平均值'}
                            ]
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: '最大值'},
                                {type: 'min', name: '最小值'}
                            ]
                        },
                        showSymbol: false
                    }, {
                        name: 'B相功率因数',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.B_power_factor;
                        }),
                        markLine: {
                            data: [
                                {type: 'average', name: '平均值'}
                            ]
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: '最大值'},
                                {type: 'min', name: '最小值'}
                            ]
                        },
                        showSymbol: false
                    }, {
                        name: 'C相功率因数',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.C_power_factor;
                        }),
                        markLine: {
                            data: [
                                {type: 'average', name: '平均值'}
                            ]
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: '最大值'},
                                {type: 'min', name: '最小值'}
                            ]
                        },
                        showSymbol: false
                    }, {
                        name: '3相总功率因数',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.Total_power_factor;
                        }),
                        markLine: {
                            data: [
                                {type: 'average', name: '平均值'}
                            ]
                        },
                        markPoint: {
                            data: [
                                {type: 'max', name: '最大值'},
                                {type: 'min', name: '最小值'}
                            ]
                        },
                        showSymbol: false
                    }]
                };
                powerfactorChart.setOption(option3);

                var option4 = {
                    title: {
                        text: '24小时数据',
                        subtext: '5分钟一条'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data:['3相总正向有功电能']
                    },
                    toolbox:{
                        show: true,
                        orient: 'vertical',
                        left: 'right',
                        top: 'center',
                        feature: {
                            mark: {show: true},
                            dataView: {show: true, readOnly: false},
                            magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                            restore: {show: true},
                            saveAsImage: {show: true}
                        }
                    },
                    calculable: true,
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '3%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: dateList,
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        axisLabel: {
                            formatter: function (val) {
                                return val;
                            }
                        },
                        splitLine: {
                            show: false
                        },
                        boundaryGap: [0, '100%'],
                        scale: true
                    },
                    series: [ {
                        name: '3相总正向有功电能',
                        type: 'line',
                        data: re.obj.map(function (item) {
                            return item.Total_p_at_ee;
                        }),

                        showSymbol: false
                    }]
                };
                totalPateeChart.setOption(option4);

            } else {
                layer.alert("数据获取失败", {icon: 2, title: '错误'})
            }
        });
    }

</script>


